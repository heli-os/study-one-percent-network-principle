# Chapter_05 서버측의 LAN에는 무엇이 있는가?

## 1. 웹 서버의 설치 장소

### **사내에 웹 서버를 설치하는 경우**

- 사내의 LAN에 서버를 설치하고 인터넷에서 직접 액세는 하는 경우 IP주소 부족 문제가 발생할 수 있음
- 사내 LAN이 인터넷에 직접 액세스 하는 경우 인터넷에서 도착하는 모든 패킷을 수신하기 때문에 공격자에게 웹 서버가 노출될 수 있음. 이를 방지하기 위해 방화벽 구성이 일반화 되어있음

### **데이터센터에 웹 서버를 설치하는 경우**

- 데이터센터는 프로바이더 중심 부분에 직접 접속해 있거나 IX에 직결되어 있어 서버를 설치할 경우 고속으로 액세스가 가능하다.
- 데이터센터가 서버의 설치장소를 제공할 뿐만 아니라 가동 상태 감시, 방화벽의 설치 운영, 부정 침입 감시라는 부가 서비스를 제공한다.
- 웹 서버가 데이터센터에 설치된 경우에는 인터넷의 중심 부분에서 데이터센터로 패킷이 흘러가고 여기에서 서버 머신에 도착한다.

```java
💡 데이터센터란 프로바이더 등이 운영하는 데이터센터라는 시설에 서버를 설치하거나, 
	 프로바이더가 소유하는 서버를 빌려쓰는 형태

💡 서버의 설치 장소와 관계 없이 지금은 바로 앞에 방화벽이 있는 것이 보통이다.
```

<br>

## 2. 방화벽의 원리와 동작

### **패킷 필터링형이 주류이다**

- 네트워크는 다양한 종류의 패킷이 흐르기 때문에 특정 서버(호스트)나 특정 애플리케이션(포트)으로 차단할 패킷을 선별하는 것은 한계가 있다.
- 통과시킬 패킷과 차단할 패킷을 선별하기 위해 고안된 다양한 방법 중 **패킷 필터링형**이 가장 많이 보급되었다.

### **패킷 필터링의 조건 설정 개념**

- 패킷의 헤더에는 통신 동작을 제어하는 제어 정보가 있다. 이것을 조사하여 패킷 필터링 조건 설정에 맞게 필터링 한다.
- 제어 정보는 MAC, IP, TCP or UDP 헤더의 정보를 사용한다.


#### ✔ 패킷 필터링 조건 설정

- 수신처 IP 주소와 송신처 IP 주소에 따라 시점과 종점을 판단하고 조건에 맞는 패킷만 통과 시킨다.
- 송신처 IP 주소에 따라 시점을 지정할 수 없으면 수신처 IP주소가 웹 서버의 IP 주소에 일치하는 패킷만 통과시킨다는 조건을 설정한다.
- 시점을 지정할 수 없는 경우에는 송신처 IP 주소를 조건으로 지정하지 않아도 된다.


### 애플리케이션을 한정할 때 포트 번호를 사용한다.

- 인터넷과 웹 서버 사이에 흐르는 패킷을 전부 통과시키면 정보가 누설될 수 있어서 위험하다.
- 정보가 누설되는 것을 방지하기 위해 필요한 애플리케이션을 제외하고 불필요한 패킷은 전부 차단하는 것이 안전하다.
- 특정 애플리케이션을 한정하여 패킷을 수신하려면 TCP 헤더나 UDP 헤더에 기록되어 있는 포트번호를 조건으로 한다.
    - ex) 웹 서버를 예로 들면, 수신처 IP 주소가 웹서버의 주소와 일치하고 수신처 포트가 80이면 통과
    

### **컨트롤 비트로 접속 방향을 판단한다.**

- 웹의 동작은 TCP 프로토콜을 사용하여 양방향이므로 한쪽 패킷 흐름이 정지되면 다른쪽 패킷 흐름도 정지되기 때문에 단순히 패킷의 흐름 방향이 아닌 액세스 방향을 판단하여 차단해야 한다.
- 액세스 방향을 판단할 때 사용되는 것이 TCP 헤더에 있는 컨트롤 비트이다. 최초의 패킷은 SYN 비트가 1이고  ACK 비트가 0이다. 그 이후 패킷에서 동일한 값을 취하는 경우는 없으므로 이 값을 조사해서 최초의 패킷과 이후 패킷을 판별할 수 있다.
- 제어 정보를 조합하여 액세스 동작에서 흐르는 패킷과 그 외의 패킷을 완별히 선별할 수 있을 때까지 조건을 추가해야 한다.

<br>


```
실제로 통과시키는 것과 차단해야 하는 패킷을 완전히 선별할 수 없는 경우가 있다. DNS 서버에 대한 액세스가
대표적인 예이다. DNS 서버의 조회 동작에서 사용되는 프로토콜은 UDP를 사용하는데, UDP는 TCP와 달리 접속
단계의 동작이 없으므로 TCP처럼 컨트롤 비트에 의해 액세스 방향을 판별할 수 없다. 이러한 특징은 UDP를 사용
하는 모든 애플리케이션에 해당된다. 이와 같은 경우에는 패킷필터링 이외의 방법을 사용하면 어느정도 해결이 된다.
```

### 방화벽으로 막을 수 없는 공격

- 방화벽은 패킷의 흐름 시점과 종점을 보고 차단여부를 결정하기 때문에 특수한 데이터가 담긴 패킷을 차단할 수 없다. 특수한 데이터의 패킷은 특정 서버를 다운시킬 위험이 있다.
- 해결 방법으론 애플리케이션의 버그를 고쳐 소프트웨어가 다운되지 않도록 하는 것과 보안 구멍 정보를 수집하여 항상 새로운 버전으로 갱신하는 것이 중요하다
- 다른 방법으로는 패킷의 내용을 조사하여 위험한 데이터가 포함되어있는지 확인하는 장치나 소프트웨어를 방화벽과는 별도로 준비하는 것이다.

<br>

## 3. 복수 서버에 리퀘스트를 분배한 서버의 부하 분산

> 대량의 패킷을 서버의 처리능력 부족으로 감당하지 못할 때는 복수의 서버를 사용하여 서버 한 대당의 처리량을 줄이는 방법이 효과적이다. 이러한 처리 방법을 분산 처리라고 하는데, 처리를 분담하는 방식은 여러가지이다. 가장 간단한 방법은 단순하게 여러 대의 웹 서버를 설치하여 한 대가 담당하는 사용자 수를 줄이는 방법이다.
> 

### **분산 처리 방법**

#### 3.1 DNS

1. 방식
    1. DNS 서버에 같은 이름으로 여러대의 웹 서버를 등록하여 `라운드로빈` 방식으로 조회가 있을 때마다 차례대로 순서를 변경하면서 IP 주소를 되돌려준다.
2. 문제점
    1. DNS는 웹 서버가 동작하지 않는지 확인하지 못하므로 웹 서버가 정지해도 상관하지 않고 IP 주소를 회답하게 된다.
    2. 복수의 페이지에 걸쳐서 대화할 경우 웹 서버가 변하면 대화가 도중에 끊어질 수 있는 문제점이 있다.

<br>

#### DNS 방식 동작예시

예를 들어 [www.lab.cyber.co.kr](http://www.lab.cyber.co.kr) 이라는 서버명에 대해 **[192.0.2.60, 192.0.2.70, 192.0.2.80]** 이라는 3개의 IP 주소를 대응시킨다고 가정했을 때 아래 순서로 IP 주소를 반납한다.

```
1. 최초의 조회에는  [192.0.2.60, 192.0.2.70, 192.0.2.80]
2. 그 다음은 순서를 변경하여 [192.0.2.70, 192.0.2.80, 192.0.2.60]
3. 세번째 조회 시 [192.0.2.80, 192.0.2.60, 192.0.2.70] 을 회답하는 방식이다. 
```

*💡 최근에는 많은 브라우저가 IP 주소 조회를 실패할 때 다음 IP 주소를 조회하는 기능을 많이 가지고 있으므로 정지해있는 웹 서버의 IP 주소를 회답해도 큰 문제가 되지 않는다.*

<br>

#### 3.2 부하 분산 장치, 로드밸런서

DNS 서버만으로 처리하는 방식의 문제점을 피하기 위해 `부하 분산 장치` 또는 `로드 밸런서` 등으로 불리는 기기를 사용하는 방법도 존재한다.

#### 부하 분산 장치

1. 방식
    1. 부하 분산 장치를 웹 서버 대신 DNS 서버에 등록한다. 그러면 클라이언트는 부하 분산 장치가 웹 서버라고 생각하고 여기에 리퀘스트 메세지를 보낸다.
    2. 부하 분산 장치는 가지고 있는 웹 서버 중에 어느 서버에 리퀘스트를 보낼지 판단한다.
    3. 판단 근거는 여러가지가 있는데 그 중 복수의 페이지에 걸쳐있는지에 따라 판단결과 기준이 크게 달라진다.
    4. 그렇지 않을 경우에는 웹 서버의 부하 상태가 판단의 근거가 된다. 단 웹 서버의 부하는 단시간에 증가하거나 감소하므로 상황을 꼼꼼히 조사해야 한다.
    5. 그렇다고 너무 자세한 상황을 조사하게 되면 부하를 조사하는 동작만으로 웹 서버의 부하가 증가한다.
2. 문제점
    1. 부하를 조사하는 동작만으로 웹 서버의 부하를 증가시킬 수 있음
    2. 복수의 페이지에 걸쳐 대화하는 애플리케이션의 경우 HTTP의 특성 때문에 이전 리퀘스트와의 관계를 판단하기 어려움
        1. 현재는 헤더의 정보를 조사하여 이전 리퀘스트와의 전후 관계를 판단함 
        
        
<br>

## 4. 캐시 서버를 이용한 서버의 부하 분산

### **캐시 서버의 이용**

- 캐시 서버는 `프록시` 라는 구조를 사용하여 데이터를 캐시에 저장하는 서버이다.
- 프록신는 액세스 동작을 중개할 때 웹 서버에서 받은 데이터를 디스크에 저장해두고 웹 서버를 대신하여 데이터를 클라이언트에게 반송하는 기능을 가지고 있다. 이것을 `캐시` 라고 부른다.
- 캐시서버는 웹 서버에서 진행하는 점검 작업을 수행하지 않고 웹 서버에서 받아 보존해둔 데이터를 클라이언트에게 송신만 하므로 웹 서버보다 빨리 데이터를 송신할 수 있다.
- 캐시서버에서 리퀘스트를 처리하면 그만큼 웹서버의 부하가 감소하여 웹 서버의 처리 시간 단축 효과가 있다.

### **캐시 서버는 갱신일로 콘텐츠를 관리한다.**

- 캐시서버를 사용할 때는 부하 분산 장치와 마찬가지로 웹 서버대신 DNS 서버에 등록한다.
- 웹 서버대신 리퀘스트를 받으면 캐시서버는 요청받은 데이터의 존재여부를 확인하고 데이터가 존재하면 클라이언트에게 송신한다. 데이터가 없을 경우에는 웹 서버에 해당 데이터를 요청한다.
- 캐시 서버를 경우할 경우 리퀘스트 메세지에 캐시 서버를 경우한 것을 나타내는 `Via 헤더 필드`를 추가한다.
- 캐시 서버에 데이터가 존재하면 캐시 서버는 데이터의 변경 여부를 판단하기 위해 `If-Modified-Since` 라는 `헤더 필드`를 추가하여 웹 서버에 전송한다.
- 데이터가 캐싱되지 않은 경우에는 웹 서버에서 반송한 최신 데이터를 캐시서버에 기록하고 클라이언트에게 응답할 때 기록된 데이터와 `Via 헤더`를 리퀘스트 메세지에 부가하여 사용자게에 전송한다

#### 연결되어있는 웹 서버가 여러대일 경우

캐시서버와 연결되어있는 웹 서버가 한 대밖에 없으면 웹 서버의 도메인명이나 IP 주소를 캐시서버에 설정해놓고 무조건 거기에 전송하는 방법을 취한다. 

그런데 여러대의 서버가 설정되어있는 경우에는 리퀘스트 메세지마다 전송 대상의 웹 서버를 판단해야 한다. 이떄 대표적인 방법으로는 리퀘스트 메세지의 URI에 쓰여있는 디렉토리를 보고 판단한다.

```
캐시 서버의 대략적인 동작방법을 보면 클라이언트와 웹 서버 사이에서 중개자의 역할을 담당하고 있는 것을 
확인할 수 있다. 이처럼 클라이언트와 웹 서버 사이를 중개하는 것이 **프록시 구조**이다.
```

### **프록시의 원점은 포워드 프록시이다.**

- 프록시의 원형은 프록시 서버를 클라이언트측에 두는 `포워드 프록시`이다.
- 포워드 프록시는 캐시를 이용하는 것도 목적이지만, 방화벽의 단점을 보완하여 사용하기 위해 고안된 방법이다.
- 포워드 프록시는 브라우저 설정 화면에 프록시 서버라는 항목에 포워드 프록시의 IP를 등록하여 사용한다.
- 포워드 프록시를 브라우저에 등록하면 URL 내용에 관계없이 모든 요청을 포워드 프록시에 전송한다.
- 포워드 프록시는 브라우저에 설정하여 사용하기 때문에 잘못 설정할 경우 브라우저가 제대로 동작하지 않는 장애의 원인이 될 수 있다.

*💡 인터넷에 공개하는 웹 서버의 경우 누가 액세스하는지 알 수 없기 때문에 웹 서버의 바로 앞에 프록시를 두는 방법을 선택하지 않는다.*

### **포워드 프록시를 개량한 리버스 프록시**

> 인터넷에 공개하는 웹 서버의 경우 누가 액세스하는지 알 수 없기 때문에 웹 서버의 바로 앞에 프록시를 두는 방법을 선택하지 않는다. 이에 따라 브라우저에 프록시를 설정하지 않아도 사용할 수 있도록 개량된 것을
> 
> 
>  `리버스 프록시` 라고 한다.
> 


#### 리버스 프록시

- 리버스 프록시는 리퀘스트 메세지의 URI에 쓰여있는 디렉토리명과 전송대상의 웹 서버를 대응시켜서 URI 부분에 http://..... 라고 쓰여있지 않은 보통의 리퀘스트 메세지를 전송할 수 있도록 하였다.
- 리버스 프록시는 서버측에서 설치하는 캐시 서버에서 채택하는 방식이다.

<br>


#### 트랜스페어런트 프록시

- 리퀘스트 메시지 패킷의 Host 헤더를 조사하여 전송 대상을 판단하는 방법을 `트랜스페어런트 프록시` 라고 한다.
- 트랜스페어런트 프록시는 보통의 리퀘스트 메시지를 전송할 수 있고 전송 대상을 캐시 서버에 설정할 필요도 없다. 어느 웹 서버에서나 전송이 가능하다
- 트랜스페어런트 프록시는 브라우저에서 웹 서버로 흘러가는 길에 설치하여 메시지가 트랜스페이런트 프록시를 통과할 때 메시지를 가로챈다.
- 리퀘스트 메시지가 흐르는 길이 많으면 여기에 전부 트랜스페어런트 프록시를 설치해야 하므로 길이 한 개로 수렴하는 형태로 네트워크를 만들고 수렴되는 곳에 트랜스페이런트 프록시를 설치하는 것이 보통이다.
- 트랜스페어런트 프록시를 사용하면 사용자가 프록시의 존재를 알아차릴 필요가 거의 없다.


<br>


## 5. 콘텐츠 배포 서비스

### **콘텐츠 배포 서비스를 이용한 부하 분산**

> 클라이언트에 두는 캐시 서버는 클라이언트측이 소유하고 있으므로 웹 서버 운영자가 제어할 수 없다.
> 
> 
> 서버측에 캐시 서버를 두는 방버은 웹 서버의 부하를 경감하는 효과는 있지만 인터넷을 흐르는 트래픽을 억제하는 효과는 없다. 이처럼 캐시 서버는 놓는 장소에 따라 장점과 단점이 있지만 양쪽의 좋은 점을 취한 방법도 존재한다. 프로바이더와 계약하여 웹 서버 운영자가 제어할 수 있는 캐시 서버를 클라이언트측의 프로바이더에게 두는 방법이다.
> 

#### CDSP (Content Delivery Service Provieder)

- CDSP는 중요한 프로바이더와 계약하고 그곳에 다수의 캐시 서버를 설치하는 방식이다.
- CDSP는 웹 서버 운영자와도 계약하여 웹 서버와 CDSP의 캐시 서버를 연대시킨다.
- 캐시 서버는 다수의 웹 서버의 데이터를 캐시에 저장할 수 있으므로 CDSP가 설치한 캐시 서버를 다수의 웹 서버 운영자가 공동으로 이용할 수도 있다.
- CDSP는 캐시서버를 대출하는 서비스를 제공하여 웹 서버 운영자가 직접 프로바이더와 계약하여 캐시서버를 설치하는 비용과 노력을 대신한다.
